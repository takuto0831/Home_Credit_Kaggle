---
title: "Preprocess_app"
author: "kotsubo takuto"
output: 
    html_document:
      md_extensions: -ascii_identifiers
      toc: true
      toc_depth: 3
---

## Data description

- application_{train|test}.csv (122|121 variables)
    - Key variable: SK_ID_CURR
    - Objective variable: TARGET(1:返済困難, 0: other, 連続値)
    - About: 全てのアプリケーションのデータ

# Setting{.tabset .tabset-fade .tabset-pills}

## knitr option

```{r reset, include=FALSE}
# 初期化
rm(list = ls())
```

```{r set up, message=FALSE}
# set directory
setwd("~/Desktop/Home_Credit_Kaggle/") 
# max.print 
options(max.print="200", digits=5)
# Global options
library(knitr)
opts_chunk$set(echo=TRUE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

## Library package

- 必要なパッケージを適宜追加

```{r package, message=FALSE}
library(tidyverse)
library(readr) # for csv
library(summarytools) # summary easily for EDA
library(GGally) # ggpairs
library(skimr) 
library(missForest)
library(imputeMissings)
library(mi)
library(doParallel)
library(qgraph)
library(psych)
library(fastcluster)
```

## Load funciton

```{r cache=FALSE}
source('~/Desktop/Home_Credit_Kaggle/script/function.R') # for preprocessing
```

## read csv

- Missing value
na = c("XNA","NA","","NaN","?"): 以下の設定で naを計上する.

- convert charcter type into factor type

```{r}
# 訓練データ, テストデータ
app_train <- read_csv("~/Desktop/Home_Credit_Kaggle/csv/application_train.csv",na = c("XNA","NA","","NaN","?")) %>% 
    mutate_if(is.character, funs(factor(.)))
app_test <- read_csv("~/Desktop/Home_Credit_Kaggle/csv/application_test.csv",na = c("XNA","NA","","NaN","?")) %>% 
  mutate_if(is.character, funs(factor(.)))
```

# Preprocess

- Check for imputation values
- Describe the details on the explanation sheet
- Add `_imp` to the supplemented column
- Add `_add` to the added column

## impute missing values{.tabset .tabset-fade .tabset-pills}

- 検証内容
    - データ特性に従って欠損値を推定
    - 多重代入法などのアルゴリムに従って, 欠損値を推定

### CODE_GENDER 

- 少ないので放置 (欠損値:4つ)

```{r}
app_train %>% 
  select(CODE_GENDER) %>% 
  table(exclude = NULL)

app_test %>% 
  select(CODE_GENDER) %>% 
  table(exclude = NULL)
```

### NAME_TYPE_SUITE

- 同行者の情報
- 無記載 = 同行者なしと考える

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(NAME_TYPE_SUITE_imp = replace(NAME_TYPE_SUITE, is.na(NAME_TYPE_SUITE),"Unaccompanied")) 
app_test <- app_test %>% 
  mutate(NAME_TYPE_SUITE_imp = replace(NAME_TYPE_SUITE, is.na(NAME_TYPE_SUITE),"Unaccompanied")) 
```

### OCCUPATION_TYPE

- other, フリーターの項目がない
- 所属=NA and 職業=NA -> 無職,無所属
- 所属=NA, 職業=NA -> other

```{r}
app_train %>% select(OCCUPATION_TYPE) %>% table()
app_test %>% select(OCCUPATION_TYPE) %>% table()
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(OCCUPATION_TYPE_imp = ifelse(!is.na(OCCUPATION_TYPE),OCCUPATION_TYPE %>% as.character(),
                                      ifelse(is.na(ORGANIZATION_TYPE),"Unemployed","other"))) %>% 
  mutate(OCCUPATION_TYPE_imp = OCCUPATION_TYPE_imp %>% as.factor())

app_test <- app_test %>% 
  mutate(OCCUPATION_TYPE_imp = ifelse(!is.na(OCCUPATION_TYPE),OCCUPATION_TYPE %>% as.character(),
                                      ifelse(is.na(ORGANIZATION_TYPE),"Unemployed","other"))) %>% 
  mutate(OCCUPATION_TYPE_imp = OCCUPATION_TYPE_imp %>% as.factor())
```

### ORGANIZATION_TYPE 

- 所属=NAはほぼ, 職業=NA (例外は2件のみ)
- 所属=NA and 職業=NA -> 無職,無所属
- 所属=NA, 職業=NA -> other

```{r}
app_train %>% select(ORGANIZATION_TYPE,OCCUPATION_TYPE) %>% table(exclude = NULL) 
#app_train %>% select(ORGANIZATION_TYPE_imp,OCCUPATION_TYPE_imp) %>% table(exclude = NULL) 
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(ORGANIZATION_TYPE_imp = ifelse(!is.na(ORGANIZATION_TYPE),ORGANIZATION_TYPE %>% as.character(),
                                      ifelse(is.na(OCCUPATION_TYPE),"Unemployed","Other"))) %>% 
  mutate(ORGANIZATION_TYPE_imp = ORGANIZATION_TYPE_imp %>% as.factor())

app_test <- app_test %>% 
  mutate(ORGANIZATION_TYPE_imp = ifelse(!is.na(ORGANIZATION_TYPE),ORGANIZATION_TYPE %>% as.character(),
                                      ifelse(is.na(OCCUPATION_TYPE),"Unemployed","other"))) %>% 
  mutate(ORGANIZATION_TYPE_imp = ORGANIZATION_TYPE_imp %>% as.factor())
```

### OWN_CAR_AGE

- 車の年数
- 車の所持データとほぼ一致(5件: 車保持かつ年数不明があった)
- 放置

```{r}
app_train %>% select(FLAG_OWN_CAR,OWN_CAR_AGE) %>% table(exclude = NULL) 
```

### CNT_FAM_MEMBERS

- 家族の人数
- 欠損値は一人と考える

```{r}
# 子どもの人数 / 家族の人数
app_train %>% select(CNT_CHILDREN,CNT_FAM_MEMBERS) %>% table(exclude = NULL) 
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(CNT_FAM_MEMBERS_imp = ifelse(is.na(CNT_FAM_MEMBERS),1,CNT_FAM_MEMBERS )) 
app_test <- app_test %>% 
  mutate(CNT_FAM_MEMBERS_imp = ifelse(is.na(CNT_FAM_MEMBERS),1,CNT_FAM_MEMBERS )) 
```

### EXT_SOURCE_??

- data list
    - EXT_SOURCE_1
    - EXT_SOURCE_2
    - EXT_SOURCE_3

- 何かの外部データ, 影響が強いので要検証
- 収入とクレジットを元に, 多重代入法による欠損値補完(error)


```{r}
app_train %>% 
  select(EXT_SOURCE_1,EXT_SOURCE_2,EXT_SOURCE_3,DAYS_BIRTH,DAYS_ID_PUBLISH,OCCUPATION_TYPE) %>% 
  na.omit() %>% 
  ggpairs(cardinality_threshold=20)

app_train %>% 
  select(EXT_SOURCE_1,EXT_SOURCE_2) %>% 
  plot()
```

- error 発生する

```{r eval=FALSE}
# data
data1 <- app_train %>% select_if(grepl(paste(c("EXT_SOURCE","AMT_CREDIT","AMT_INCOME_TOTAL"), collapse="|"),names(.)))
data2 <- app_test %>% select_if(grepl(paste(c("EXT_SOURCE","AMT_CREDIT","AMT_INCOME_TOTAL"), collapse="|"),names(.)))
# str_c(a,collapse = "', '")  
patterns <- c("EXT_SOURCE_1","EXT_SOURCE_2","EXT_SOURCE_3")
# 欠損値補完 
tmp1 <- ImputeMissingValueMI(data1,patterns)
tmp2 <- ImputeMissingValueMI(data2,patterns)
  
# データ結合
app_train <- cbind(app_train,tmp1)
app_test <- cbind(app_test,tmp2)
```

### ???_AVG

- data list
    - APARTMENTS_AVG
    - BASEMENTAREA_AVG
    - YEARS_BEGINEXPLUATATION_AVG
    - YEARS_BUILD_AVG
    - COMMONAREA_AVG
    - ELEVATORS_AVG
    - ENTRANCES_AVG
    - FLOORSMAX_AVG
    - FLOORSMIN_AVG
    - LANDAREA_AVG
    - LIVINGAPARTMENTS_AVG
    - LIVINGAREA_AVG
    - NONLIVINGAPARTMENTS_AVG
    - NONLIVINGAREA_AVG

- 住居等に関数正規化された情報
- 平均項目
- 14項目
- 保留

```{r}
app_train %>% 
  select_if(grepl("_AVG",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  qgraph(edge.labels=T)

app_train %>% 
  select_if(grepl("_AVG",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  cor.plot(numbers = TRUE)
```

```{r eval=FALSE}
# data
data1 <- app_train %>% select_if(grepl("_AVG",names(.)))
data2 <- app_test %>% select_if(grepl("_AVG",names(.)))
# str_c(a,collapse = "', '")
patterns <- c("APARTMENTS_AVG", "BASEMENTAREA_AVG", "YEARS_BEGINEXPLUATATION_AVG", "YEARS_BUILD_AVG", "COMMONAREA_AVG",
              "ELEVATORS_AVG", "ENTRANCES_AVG", "FLOORSMAX_AVG", "FLOORSMIN_AVG", "LANDAREA_AVG","LIVINGAPARTMENTS_AVG",
              "LIVINGAREA_AVG", "NONLIVINGAPARTMENTS_AVG", "NONLIVINGAREA_AVG")
# 欠損値補完
tmp1 <- ImputeMissingValueMI(data1,patterns)
tmp2 <- ImputeMissingValueMI(data2,patterns)

# データ結合
app_train <- cbind(app_train,tmp1)
app_test <- cbind(app_test,tmp2)
```

### ???_MEDI

- data list
    - APARTMENTS_MEDI
    - BASEMENTAREA_MEDI
    - YEARS_BEGINEXPLUATATION_MEDI
    - YEARS_BUILD_MEDI
    - COMMONAREA_MEDI
    - ELEVATORS_MEDI
    - ENTRANCES_MEDI
    - FLOORSMAX_MEDI
    - FLOORSMIN_MEDI
    - LANDAREA_MEDI
    - LIVINGAPARTMENTS_MEDI
    - LIVINGAREA_MEDI
    - NONLIVINGAPARTMENTS_MEDI
    - NONLIVINGAREA_MEDI

- 住居等に関数正規化された情報
- 中央値
- 14項目
- 保留

```{r}
app_train %>% 
  select_if(grepl("_MEDI",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  qgraph(edge.labels=T)

app_train %>% 
  select_if(grepl("_MEDI",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  cor.plot(numbers = TRUE)
```

```{r eval=FALSE}
# data
data1 <- app_train %>% select_if(grepl("_MEDI",names(.)))
data2 <- app_test %>% select_if(grepl("_MEDI",names(.)))
# str_c(a,collapse = "', '")
patterns <- c("APARTMENTS_MEDI", "BASEMENTAREA_MEDI", "YEARS_BEGINEXPLUATATION_MEDI", "YEARS_BUILD_MEDI", "COMMONAREA_MEDI",
              "ELEVATORS_MEDI", "ENTRANCES_MEDI", "FLOORSMAX_MEDI", "FLOORSMIN_MEDI", "LANDAREA_MEDI", "LIVINGAPARTMENTS_MEDI",
              "LIVINGAREA_MEDI", "NONLIVINGAPARTMENTS_MEDI", "NONLIVINGAREA_MEDI")
# 欠損値補完
tmp1 <- ImputeMissingValueMI(data1,patterns)
tmp2 <- ImputeMissingValueMI(data2,patterns)

# データ結合
app_train <- cbind(app_train,tmp1)
app_test <- cbind(app_test,tmp2)
```

### ???_MODE

建物に関する諸情報(標準化済み)

- factor data
    - FONDKAPREMONT_MODE (カラムがよくわからない)
    - HOUSETYPE_MODE
    - WALLSMATERIAL_MODE
    - TOTALAREA_MODE (敷地面積?)
    - EMERGENCYSTATE_MODE (No or Yes) -> 欠損値 = NOとする
    
- numeric data
    - APARTMENTS_MODE
    - BASEMENTAREA_MODE
    - YEARS_BEGINEXPLUATATION_MODE
    - YEARS_BUILD_MODE
    - COMMONAREA_MODE
    - ELEVATORS_MODE
    - ENTRANCES_MODE
    - FLOORSMAX_MODE
    - FLOORSMIN_MODE
    - LANDAREA_MODE
    - LIVINGAPARTMENTS_MODE
    - LIVINGAREA_MODE
    - NONLIVINGAPARTMENTS_MODE
    - NONLIVINGAREA_MODE

- numeric: 14項目
- factor: 5項目
- EMERGENCYSTATE_MODE 以外保留

#### factor value 

```{r}
app_train %>% select(HOUSETYPE_MODE,WALLSMATERIAL_MODE) %>% table(exclude = NULL) 
app_train %>% select(FONDKAPREMONT_MODE,WALLSMATERIAL_MODE) %>% table(exclude = NULL) 
app_train %>% select(HOUSETYPE_MODE,FONDKAPREMONT_MODE) %>% table(exclude = NULL) 
app_train$TOTALAREA_MODE %>% graphics::hist(breaks = 30)

app_train %>% 
  select(HOUSETYPE_MODE,WALLSMATERIAL_MODE,FONDKAPREMONT_MODE,TOTALAREA_MODE) %>% 
  na.omit() %>% 
  ggpairs()
```

```{r eval=TRUE}
# ## impute 1
# # data
# data1 <- app_train %>% select(HOUSETYPE_MODE,WALLSMATERIAL_MODE,FONDKAPREMONT_MODE,TOTALAREA_MODE)
# data2 <- app_test %>% select(HOUSETYPE_MODE,WALLSMATERIAL_MODE,FONDKAPREMONT_MODE,TOTALAREA_MODE)
# patterns <- c("HOUSETYPE_MODE","WALLSMATERIAL_MODE","FONDKAPREMONT_MODE","TOTALAREA_MODE") 
# # 欠損値補完 
# tmp1 <- ImputeMissingValueRF(data1,patterns)
# tmp2 <- ImputeMissingValueRF(data2,patterns)
# # データ結合
# app_train <- cbind(app_train,tmp1)
# app_test <- cbind(app_test,tmp2)

## impute 2
app_train <- app_train %>% 
  mutate(EMERGENCYSTATE_MODE_imp = ifelse(is.na(EMERGENCYSTATE_MODE),"No",EMERGENCYSTATE_MODE %>% as.character())) %>% 
  mutate(EMERGENCYSTATE_MODE_imp = EMERGENCYSTATE_MODE_imp %>% as.factor())
app_test <- app_test %>% 
  mutate(EMERGENCYSTATE_MODE_imp = ifelse(is.na(EMERGENCYSTATE_MODE),"No",EMERGENCYSTATE_MODE %>% as.character())) %>% 
  mutate(EMERGENCYSTATE_MODE_imp = EMERGENCYSTATE_MODE_imp %>% as.factor())
```

#### numeric value

```{r}
tmp <- c("HOUSETYPE_MODE","WALLSMATERIAL_MODE","FONDKAPREMONT_MODE","TOTALAREA_MODE","EMERGENCYSTATE_MODE")
app_train %>% 
  select_if(grepl("_MODE",names(.))) %>% 
  select_if(!grepl(paste(tmp, collapse="|"),names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  qgraph(edge.labels=T)

app_train %>% 
  select_if(grepl("_MODE",names(.))) %>% 
  select_if(!grepl(paste(tmp, collapse="|"),names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  cor.plot(numbers = TRUE)
```

```{r eval=FALSE}
# exclude
tmp <- c("HOUSETYPE_MODE","WALLSMATERIAL_MODE","FONDKAPREMONT_MODE","TOTALAREA_MODE","EMERGENCYSTATE_MODE")
# data
data1 <- app_train %>% select_if(grepl("_MODE",names(.))) %>% select_if(!grepl(paste(tmp, collapse="|"),names(.)))
data2 <- app_test %>% select_if(grepl("_MODE",names(.))) %>% select_if(!grepl(paste(tmp, collapse="|"),names(.)))
# str_c(a,collapse = "', '")
patterns <- c( "APARTMENTS_MODE", "BASEMENTAREA_MODE", "YEARS_BEGINEXPLUATATION_MODE", "YEARS_BUILD_MODE", "COMMONAREA_MODE",
               "ELEVATORS_MODE", "ENTRANCES_MODE", "FLOORSMAX_MODE", "FLOORSMIN_MODE", "LANDAREA_MODE", "LIVINGAPARTMENTS_MODE",
               "LIVINGAREA_MODE", "NONLIVINGAPARTMENTS_MODE", "NONLIVINGAREA_MODE")
# 欠損値補完
tmp1 <- ImputeMissingValueMI(data1,patterns)
tmp2 <- ImputeMissingValueMI(data2,patterns)

# データ結合
app_train <- cbind(app_train,tmp1)
app_test <- cbind(app_test,tmp2)
```

### ????_CIRCLE

- data list
    - OBS_30_CNT_SOCIAL_CIRCLE
    - DEF_30_CNT_SOCIAL_CIRCLE
    - OBS_60_CNT_SOCIAL_CIRCLE
    - DEF_60_CNT_SOCIAL_CIRCLE

- 観測されていない => 0

```{r}
app_train %>% 
  select_if(grepl("_CIRCLE",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  qgraph(edge.labels=T)

app_train %>% 
  select_if(grepl("_CIRCLE",names(.))) %>% 
  na.omit() %>%
  cor() %>% 
  cor.plot(numbers = TRUE)
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(OBS_30_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(OBS_30_CNT_SOCIAL_CIRCLE),0,OBS_30_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(DEF_30_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(DEF_30_CNT_SOCIAL_CIRCLE),0,DEF_30_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(OBS_60_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(OBS_60_CNT_SOCIAL_CIRCLE),0,OBS_60_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(DEF_60_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(DEF_60_CNT_SOCIAL_CIRCLE),0,DEF_60_CNT_SOCIAL_CIRCLE )) 
app_test <- app_test %>% 
  mutate(OBS_30_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(OBS_30_CNT_SOCIAL_CIRCLE),0,OBS_30_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(DEF_30_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(DEF_30_CNT_SOCIAL_CIRCLE),0,DEF_30_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(OBS_60_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(OBS_60_CNT_SOCIAL_CIRCLE),0,OBS_60_CNT_SOCIAL_CIRCLE )) %>% 
  mutate(DEF_60_CNT_SOCIAL_CIRCLE_imp = ifelse(is.na(DEF_60_CNT_SOCIAL_CIRCLE),0,DEF_60_CNT_SOCIAL_CIRCLE )) 
```

### DAYS_LAST_PHONE_CHANGE

- 欠損値一人
- 保留

```{r}
app_train %>% select(DAYS_LAST_PHONE_CHANGE) %>% table(exclude = NULL) 
```

### AMT_???

#### part1 

- data list
    - AMT_INCOME_TOTAL: 総収入
    - AMT_CREDIT: ローンのクレジット額
    - AMT_ANNUITY: 年金ローン
    - AMT_GOODS_PRICE: 消費者ローン

- 3つのローンの相関関係強い, 欠損値補完に使える！！

```{r}
app_train %>% 
  select(AMT_INCOME_TOTAL, AMT_CREDIT, AMT_ANNUITY, AMT_GOODS_PRICE) %>% 
  na.omit() %>% 
  ggpairs()
```

```{r eval=TRUE}
# 補完に使用するデータ
data1 <- app_train %>% select(AMT_CREDIT, AMT_ANNUITY, AMT_GOODS_PRICE) 
data2 <- app_test %>% select(AMT_CREDIT, AMT_ANNUITY, AMT_GOODS_PRICE) 
# 欠損値を含むデータ
patterns <- c("AMT_ANNUITY","AMT_GOODS_PRICE")

# 欠損値補完 (1 iter : 2000 second)
tmp1 <- ImputeMissingValueMI(data1,patterns)
tmp2 <- ImputeMissingValueMI(data2,patterns)
  
# データ結合
app_train <- cbind(app_train,tmp1)
app_test <- cbind(app_test,tmp2)
```

#### part2

- data list
    - AMT_REQ_CREDIT_BUREAU_HOUR
    - AMT_REQ_CREDIT_BUREAU_DAY
    - AMT_REQ_CREDIT_BUREAU_WEEK
    - AMT_REQ_CREDIT_BUREAU_MON
    - AMT_REQ_CREDIT_BUREAU_QRT
    - AMT_REQ_CREDIT_BUREAU_YEAR

- 何かの紹介件数 NA-> 0補完
- 関係性低い

```{r}
app_train %>% 
  select(AMT_REQ_CREDIT_BUREAU_HOUR, AMT_REQ_CREDIT_BUREAU_DAY, AMT_REQ_CREDIT_BUREAU_WEEK,
         AMT_REQ_CREDIT_BUREAU_MON, AMT_REQ_CREDIT_BUREAU_QRT, AMT_REQ_CREDIT_BUREAU_YEAR) %>% 
  na.omit() %>%
  cor() %>% 
  qgraph(edge.labels=T)

app_train %>% 
  select(AMT_REQ_CREDIT_BUREAU_HOUR, AMT_REQ_CREDIT_BUREAU_DAY, AMT_REQ_CREDIT_BUREAU_WEEK,
         AMT_REQ_CREDIT_BUREAU_MON, AMT_REQ_CREDIT_BUREAU_QRT, AMT_REQ_CREDIT_BUREAU_YEAR) %>% 
  na.omit() %>%
  cor() %>% 
  cor.plot(numbers = TRUE)
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_HOUR_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_HOUR),0,AMT_REQ_CREDIT_BUREAU_HOUR)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_DAY_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_DAY),0,AMT_REQ_CREDIT_BUREAU_DAY)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_WEEK_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_WEEK),0,AMT_REQ_CREDIT_BUREAU_WEEK)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_MON_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_MON),0,AMT_REQ_CREDIT_BUREAU_MON)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_QRT_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_QRT),0,AMT_REQ_CREDIT_BUREAU_QRT)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_YEAR_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_YEAR),0,AMT_REQ_CREDIT_BUREAU_YEAR)) 

app_test <- app_test %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_HOUR_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_HOUR),0,AMT_REQ_CREDIT_BUREAU_HOUR)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_DAY_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_DAY),0,AMT_REQ_CREDIT_BUREAU_DAY)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_WEEK_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_WEEK),0,AMT_REQ_CREDIT_BUREAU_WEEK)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_MON_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_MON),0,AMT_REQ_CREDIT_BUREAU_MON)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_QRT_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_QRT),0,AMT_REQ_CREDIT_BUREAU_QRT)) %>% 
  mutate(AMT_REQ_CREDIT_BUREAU_YEAR_imp = ifelse(is.na(AMT_REQ_CREDIT_BUREAU_YEAR),0,AMT_REQ_CREDIT_BUREAU_YEAR)) 
```

## add new column{.tabset .tabset-fade .tabset-pills}

- 新しい特徴量を作成する

### EXT_SOURCE_??

- data list
    - EXT_SOURCE_1
    - EXT_SOURCE_2
    - EXT_SOURCE_3

- 全てNAのものは172個
- 合計値と乗算値

```{r}
app_train %>% 
  filter(EXT_SOURCE_1 %>% is.na()) %>% 
  filter(EXT_SOURCE_2 %>% is.na()) %>% 
  filter(EXT_SOURCE_3 %>% is.na()) %>% 
  select(TARGET) %>% table()
```

```{r eval=TRUE}
app_train <- app_train %>% 
  mutate(tmp1 = EXT_SOURCE_1,tmp2 = EXT_SOURCE_2,tmp3 = EXT_SOURCE_3) %>% 
  mutate_at(vars(matches("tmp",.)), funs(ifelse(is.na(.),0,.))) %>% 
  mutate(EXT_SOURCE_MEAN_add = round(tmp1 + tmp2 + tmp3, digits = 4)) %>% 
  mutate(EXT_SOURCE_MULTI_add = round(tmp1 * tmp2 * tmp3, digits = 4)) %>% 
  select(-c(tmp1,tmp2,tmp3))

app_test <- app_test %>% 
  mutate(tmp1 = EXT_SOURCE_1,tmp2 = EXT_SOURCE_2,tmp3 = EXT_SOURCE_3) %>% 
  mutate_at(vars(matches("tmp",.)), funs(ifelse(is.na(.),0,.))) %>% 
  mutate(EXT_SOURCE_MEAN_add = round((tmp1 + tmp2 + tmp3)/3,digits = 4)) %>% 
  mutate(EXT_SOURCE_MULTI_add = round(tmp1 * tmp2 * tmp3,digits = 4)) %>% 
  select(-c(tmp1,tmp2,tmp3))
```

## output for csv

- Save the csv files in the csv_imp folder

```{r eval=TRUE}
write_csv(app_train,"~/Desktop/Home_Credit_Kaggle/csv_imp/application_train_imp.csv")
write_csv(app_test,"~/Desktop/Home_Credit_Kaggle/csv_imp/application_test_imp.csv")
```

